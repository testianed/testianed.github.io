<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>flowgazer</title>
<link rel="icon" type="image/x-icon" href="https://ompomz.github.io/flowgazer/favicon.ico">
<style>
* { margin: 0; padding: 0; box-sizing: border-box;}
body {font-weight: normal; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 0.5rem; line-height: 1.3; background-color: #f7f7f7; color: #666; font-size: 0.9rem;}
.container { max-width: 600px; margin-left: 0.5rem; margin-right: auto; padding: 0.5rem;}
a {color: #666; text-decoration: none;}
h1 { font-size: 1.2rem; margin-bottom: 0.5rem;}
input, textarea {transition: background-color 0.3s, color 0.3s; cursor: pointer; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; color: #666; background-color: #fff;}
input[type="checkbox"] { padding: 0; margin: 0; vertical-align: middle; appearance: checkbox; -webkit-appearance: checkbox;}
textarea { resize: vertical;}
.container button {white-space: nowrap; font-size: 0.8rem; font-weight: bold; padding: 0.25rem 1rem; margin: 0.5rem 0; border: none; border-radius: 999px; color: #fff; background-color: #666; cursor: pointer;}
.full-width { width: 100%;}
.flex-container { display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;}
.flex-container input { flex-grow: 1; margin: 0;}
.flex-container input, .flex-container textarea { flex-grow: 1; margin: 0;}
.flex-container button { margin: 0;}
ul { list-style: none; padding: 0; margin: 0.5rem 0;}
li.event {word-break: break-all; padding: 0.5rem; border-top: 1px dashed #ddd;}
.post-content{display:inline}
.event-liked { border-right: 0.3rem solid #ffd700;}
.npub-link { color: #66b3ff;}
.nostr-ref, .pubkey-ref { color: #66b3ff; text-decoration: none;}
.custom-emoji { height: 1.2rem; vertical-align: bottom;}
.tab-button { padding: 0.5rem 1rem; border: none; background: #ddd; cursor: pointer; border-radius: 4px;}
.tab-button.active { background: #66b3ff; color: #fff;}
#load-more.loading::before { content: "èª­ã¿è¾¼ã¿ä¸­...";}
#generate-trial-keypair { background-color: #ff99cc;}
#send-new-post { background-color: #ffcc66;}
#subscribe-relay, #apply-filter, #clear-filter, #load-follows { background-color: #ffd700;}
#show-settings, #hide-settings { background-color: #999; font-size: 0.7rem; padding: 0.2rem 1rem; margin: 0;}
.hidden { display: none;}
@media (max-width: 767px) { .container { max-width: 100%; padding: 8px; margin: 0;} }
#tutorial-overlay{position:fixed;top:0;left:0;width:100%;height:100%;justify-content:center;align-items:center;z-index:9999;background-color:rgba(247,247,247,.5);display:none;backdrop-filter:blur(5px);transition:all 0.5s ease-in-out}
#tutorial-modal{background-color:rgba(255,255,255,.8);padding:1.2rem 1.2rem .5rem 1.2rem;border-radius:.6rem;max-width:600px;width:80%;max-height:90vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,.2);transition:all 0.5s ease-in-out;position:relative}
#image-container{text-align:center;margin-bottom:.5rem}
.tutorial-image{display:none;max-width:100%;height:auto}
.tutorial-image.active{display:block}
#tutorial-navigation{display:flex;justify-content:space-between;margin:.5rem 0rem 0rem 0rem}
#prev-button,#next-button{width:2rem;height:2rem;display:inline-flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;color:rgba(224,242,241,1);background-color:rgba(0,121,107,.7);border:none;border-radius:50%;cursor:pointer;transition:background-color 0.3s ease,transform 0.2s ease}
#prev-button:hover,#next-button:hover{background-color:rgba(0,121,107,.9)}
#tutorial-close-button{position:absolute;top:.5rem;right:.5rem;font-size:.9rem;font-weight:700;color:#e0f2f1;background-color:#00796b;padding:.25rem .5rem;border-radius:999px;cursor:pointer;border:none;z-index:10000;white-space:nowrap;transition:background-color 0.3s}
#tutorial-close-button:hover{background-color:rgba(0,121,107,.7)}
.dot-navigation{text-align:center}
.dot{height:1rem;width:1rem;background-color:#e0f2f1;border-radius:50%;display:inline-block;margin:0 5px;cursor:pointer;transition:background-color 0.3s ease}
.dot.active{background-color:#00796b}
.modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.2);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px)}
.modal-content{margin:auto;display:block;max-width:80%;max-height:80vh;width:80%}
.modal-image{width:auto;height:auto;max-width:100%;max-height:100%;object-fit:contain;display:block;margin:auto}
.close-button{color:#fff;font-size:40px;font-weight:700;cursor:pointer;transition:0.3s}
.close-button:hover,.close-button:focus{color:#eee;text-decoration:none;cursor:pointer}
</style>
</head>
<body>
<div id="header-placeholder"></div>
<div id="modal-placeholder"></div>

<div class="container">
<div style="display: flex; justify-content: space-between; align-items: center;">
 <a href="https://github.com/ompomz/flowgazer2/"><h1>flowgazer</h1></a>
 <button onclick="showAuthUI()" style="color: #00796b; background-color: #e0f2f1; padding: 0.25rem 1rem;">ã™ã§ã«éµã‚’ãŠæŒã¡ã®æ–¹</button>
</div>

<p>æ–°è¨­è¨ˆç‰ˆï¼ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¦‹ãŸã‚Šã€æŠ•ç¨¿ã—ãŸã‚Šã€ãµãã¼ã£ãŸã‚Šã§ãã‚‹ã‚ˆã€‚ä½œã£ãŸã®ã¯Claudeã€‚</p>

<button id="generate-trial-keypair" class="full-width" onclick="generateAndLoginWithNewKeypair()">
  æ–°ã—ã„éµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¦è©¦ã™ï¼
</button>

<div style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
 <a id="npub-link" class="npub-link" target="_blank" style="display: none;"></a>
 <span id="not-logged-in" style="color: #999;">è¦‹ã‚‹ã ã‘ãƒ¢ãƒ¼ãƒ‰</span>
</div>

<textarea id="new-post-content" rows="3" placeholder="ã„ã¾ãªã«ã—ã¦ã‚‹ï¼Ÿ" class="full-width" style="margin-top:0.5rem;"></textarea>
<button id="send-new-post" class="full-width">æŠ•ç¨¿</button>

<div style="display: flex; justify-content: center;">
  <button id="show-settings">è©³ç´°è¨­å®šã‚’è¡¨ç¤º</button>
  <button id="hide-settings" class="hidden">è©³ç´°è¨­å®šã‚’éš ã™</button>
</div>

<div id="advanced-settings" class="hidden">
  <div class="flex-container">
    <input id="relay-url" type="text" list="relay-suggestions">
    <datalist id="relay-suggestions">
    <option value="wss://relay.damus.io">
    <option value="wss://nos.lol/">
    <option value="wss://relay.nostr.band">
    </datalist>
    <button id="subscribe-relay">æ¥ç¶š</button>
  </div>
  
  <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 0.25rem;">
    <label for="auto-update-toggle">è‡ªå‹•æ›´æ–°ON</label>
    <input type="checkbox" id="auto-update-toggle" checked>
    
    <label for="filter-flowgazer-only" style="margin-left: 1rem;">via flowgazer ã—ã¼ã‚Šã“ã¿</label>
    <input type="checkbox" id="filter-flowgazer-only">
    
    <label for="kind-7-content-input" style="margin-left: 1rem;">ãµãã¼ãƒãƒ¼ã‚¯</label>
    <input id="kind-7-content-input" type="text" maxlength="1" value="â­" style="width: 2.5rem; text-align: center; font-size: 0.8rem;">
  </div>
  
  <div class="flex-container">
    <textarea id="hex-filter" rows="3" placeholder="æŠ•ç¨¿è€…ã—ã¼ã‚Šã“ã¿(npub1â€¦,hexâ€¦)"></textarea>
    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
      <button id="apply-filter" style="width: 4rem;">é©ç”¨</button>
      <button id="clear-filter" style="width: 4rem;">ã‚¯ãƒªã‚¢</button>
      <button id="load-follows" style="width: 4rem;">kind:3</button>
    </div>
  </div>
</div>

<div id="tab-buttons" style="display: flex; gap: 0.5rem; margin: 0.5rem 0;">
  <button id="tab-global" class="tab-button active">ã¿ã‚“ãª</button>
  <button id="tab-following" class="tab-button">ãƒ•ã‚©ãƒ­ãƒ¼</button>
  <button id="tab-myposts" class="tab-button">è‡ªåˆ†</button>
  <button id="tab-likes" class="tab-button">ãµãã¼ã‚‰ã‚Œ</button>
</div>

<ul id="timeline"></ul>
<button id="load-more" class="full-width" style="margin: 0.1rem 0;">ã‚‚ã£ã¨è¦‹ã‚‹</button>

</div>

<!-- æ—¢å­˜JS -->
<script src="https://ompomz.github.io/header/loadHeader.js"></script>
<script src="https://ompomz.github.io/modal.js"></script>
<script src="https://ompomz.github.io/flowgazer/tutorial.js"></script>
<script src="https://ompomz.github.io/flowgazer2/auth.js"></script>
<script src="https://ompomz.github.io/flowgazer2/auth-ui.js"></script>
<script src="https://unpkg.com/nostr-tools@2.17.0/lib/nostr.bundle.js"></script>

<!-- æ–°è¨­è¨ˆJS -->
<script src="./relay-manager.js"></script>
<script src="./data-store.js"></script>
<script src="./view-state.js"></script>
<script src="./profile-fetcher.js"></script>
<script src="./timeline.js"></script>
<script src="./app.js"></script>

<script>
// åˆæœŸåŒ–ç¢ºèª
console.log('âœ… ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
console.log('dataStore:', typeof window.dataStore);
console.log('relayManager:', typeof window.relayManager);
console.log('viewState:', typeof window.viewState);
console.log('profileFetcher:', typeof window.profileFetcher);
console.log('Timeline:', typeof window.Timeline);
console.log('app:', typeof window.app);

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', async () => {
  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å­˜åœ¨ç¢ºèª
  if (!window.dataStore || !window.viewState) {
    console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼');
    alert('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„');
    return;
  }
  
  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
  window.timeline = new Timeline(document.getElementById('timeline'));
  
  // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
  await window.app.init();
  
  // UI ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  
  // æŠ•ç¨¿ãƒœã‚¿ãƒ³
  document.getElementById('send-new-post').addEventListener('click', () => {
    const content = document.getElementById('new-post-content').value;
    if (content) {
      window.app.sendPost(content);
    }
  });
  
  // Ctrl+Enter ã§æŠ•ç¨¿
  document.getElementById('new-post-content').addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('send-new-post').click();
    }
  });
  
  // ãƒªãƒ¬ãƒ¼æ¥ç¶šãƒœã‚¿ãƒ³
  document.getElementById('subscribe-relay').addEventListener('click', () => {
    const url = document.getElementById('relay-url').value;
    window.app.connectRelay(url);
  });
  
  // ã‚¿ãƒ–ãƒœã‚¿ãƒ³
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tab = e.target.id.replace('tab-', '');
      window.app.switchTab(tab);
    });
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
  document.getElementById('apply-filter').addEventListener('click', () => {
    const input = document.getElementById('hex-filter').value;
    const authors = input.split(/[ ,\n]/)
      .map(s => s.trim())
      .filter(s => s.length === 64 || s.startsWith('npub'))
      .map(s => {
        if (s.startsWith('npub')) {
          try {
            const decoded = NostrTools.nip19.decode(s);
            return decoded.data;
          } catch (e) {
            return null;
          }
        }
        return s;
      })
      .filter(Boolean);
    
    window.app.applyFilter(authors);
    localStorage.setItem('hexFilterValue', input);
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
  document.getElementById('clear-filter').addEventListener('click', () => {
    document.getElementById('hex-filter').value = '';
    window.app.applyFilter(null);
    localStorage.removeItem('hexFilterValue');
  });
  
  // ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
  document.getElementById('load-follows').addEventListener('click', () => {
    if (!window.nostrAuth.isLoggedIn()) {
      alert('éµã®å…¥åŠ›ãŒå¿…è¦ã§ã™');
      showAuthUI();
      return;
    }
    
    const pubkeys = Array.from(window.dataStore.followingPubkeys);
    if (pubkeys.length === 0) {
      alert('ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“');
      return;
    }
    
    document.getElementById('hex-filter').value = pubkeys.join('\n');
    alert(`${pubkeys.length}äººã®ãƒ•ã‚©ãƒ­ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  });
  
  // flowgazerã—ã¼ã‚Šã“ã¿
  document.getElementById('filter-flowgazer-only').addEventListener('change', (e) => {
    window.app.toggleFlowgazerFilter(e.target.checked);
  });
  
  // è‡ªå‹•æ›´æ–°ãƒˆã‚°ãƒ«
  document.getElementById('auto-update-toggle').addEventListener('change', (e) => {
    window.app.isAutoUpdate = e.target.checked;
    console.log(`ğŸ”„ è‡ªå‹•æ›´æ–°: ${e.target.checked ? 'ON' : 'OFF'}`);
    
    // OFFã‹ã‚‰ONã«ã—ãŸæ™‚ã¯å³åº§ã«æç”»
    if (e.target.checked) {
      window.viewState.renderNow();
    }
  });
  
  // ã‚‚ã£ã¨è¦‹ã‚‹
  document.getElementById('load-more').addEventListener('click', function() {
    this.classList.add('loading');
    window.app.loadMore();
  });
  
  // è©³ç´°è¨­å®šãƒˆã‚°ãƒ«
  document.getElementById('show-settings').addEventListener('click', () => {
    document.getElementById('advanced-settings').classList.remove('hidden');
    document.getElementById('show-settings').classList.add('hidden');
    document.getElementById('hide-settings').classList.remove('hidden');
  });
  
  document.getElementById('hide-settings').addEventListener('click', () => {
    document.getElementById('advanced-settings').classList.add('hidden');
    document.getElementById('hide-settings').classList.add('hidden');
    document.getElementById('show-settings').classList.remove('hidden');
  });
  
  // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¾©å…ƒ
  const savedFilter = localStorage.getItem('hexFilterValue');
  if (savedFilter) {
    document.getElementById('hex-filter').value = savedFilter;
  }
});

// æ–°è¦éµãƒšã‚¢ç”Ÿæˆ
function generateAndLoginWithNewKeypair() {
  const confirmed = confirm(
    'æ–°ã—ã„éµãƒšã‚¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚\n' +
    'ç”Ÿæˆã•ã‚ŒãŸç§˜å¯†éµï¼ˆnsecï¼‰ã¯å¤±ãã™ã¨è¦‹ã¤ã‹ã‚‰ãªã„ã®ã§\n' +
    'å¤§äº‹ã«æŒã£ã¦ãŠã„ã¦ã­ã€‚'
  );
  
  if (!confirmed) return;
  
  const seckey = window.NostrTools.generateSecretKey();
  const nsec = window.NostrTools.nip19.nsecEncode(seckey);
  
  window.nostrAuth.loginWithNsec(nsec);
  location.reload();
}
</script>

</body>
</html>